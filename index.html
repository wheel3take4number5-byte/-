<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Glider Viewer</title>
  <style>
    body { margin: 0; background: #fff; font-family: sans-serif; }
    <button id="permissionBtn">センサー許可</button>
    canvas { border: 1px solid #ccc; }
    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #fff;
      padding: 6px 12px;
      border: 1px solid #999;
      border-radius: 4px;
      font-size: 14px;
    }
    #permissionBtn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      padding: 8px 16px;
      font-size: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="info">状態: 初期化中</div>
  <button id="permissionBtn">センサー許可 </button>
  <canvas id="bankMeter" width="80" height="80" style="position:absolute; top:10px; left:10px;"></canvas>
  <canvas id="stickMeter" width="80" height="80" style="position:absolute; top:100px; left:10px;"></canvas>
  <canvas id="pitchMeter" width="80" height="80" style="position:absolute; top:190px; left:10px;"></canvas>
  <canvas id="mapArea" width="300" height="300" style="position:absolute; top:10px; left:150px;"></canvas>
  <div id="spoilerControl" style="position:absolute; right:20px; bottom:20px; background:#fff; padding:10px; border-radius:8px; border:1px solid #ccc;">
    <label for="spoilerSlider">スポイラー展開率</label>
    <input type="range" id="spoilerSlider" min="0" max="100" value="0" style="vertical-align:middle;">
    <span id="spoilerValue">0</span>%
  </div>

  <script>
    const bankCanvas = document.getElementById("bankMeter");
    const bankCtx = bankCanvas.getContext("2d");
    const stickCanvas = document.getElementById("stickMeter");
    const stickCtx = stickCanvas.getContext("2d");
    const pitchCanvas = document.getElementById("pitchMeter");
    const pitchCtx = pitchCanvas.getContext("2d");
    const mapCanvas = document.getElementById("mapArea");
    const mapCtx = mapCanvas.getContext("2d");
    const info = document.getElementById("info");
    const permissionBtn = document.getElementById("permissionBtn");

    let bankDeg = 0;
    let stickDeg = 0;
    let pitchDeg = 0;
    let xPos = mapCanvas.width / 2;
    let yPos = mapCanvas.height / 2;
    let altitude = 100;
    let velocity = 100;
    let deg = -90;
    let spoilerRatio = 0.0; // スポイラー展開率（0.0〜1.0）

    const updateInterval = 200;

    function handleOrientation(event) {
      pitchDeg = (event.gamma || 0) / -5 - 6;
      stickDeg = (event.beta || 90);
    }

    permissionBtn.onclick = () => {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              window.addEventListener("deviceorientation", handleOrientation);
              permissionBtn.style.display = "none";
              update(); // ← 許可後に開始
            } else {
              alert("センサーの許可が必要です");
            }
          })
          .catch(err => {
            console.error("センサー許可エラー:", err);
            alert("センサー許可に失敗しました");
          });
      } else {
        window.addEventListener("deviceorientation", handleOrientation);
        permissionBtn.style.display = "none";
        update(); // ← Androidなどは即開始
      }
    };

    function handleOrientation(event) {
      console.log("gamma:", event.gamma, "beta:", event.beta);
      pitchDeg = (event.gamma ?? 0)/-5 - 6;
      stickDeg = (event.beta ?? 90);
    }

    function drawBankMeter(angle) {
      const cx = bankCanvas.width / 2;
      const cy = bankCanvas.height / 2;
      const r = bankCanvas.height / 2;
      bankCtx.clearRect(0, 0, bankCanvas.width, bankCanvas.height);
      bankCtx.beginPath();
      bankCtx.arc(cx, cy, r, 0, Math.PI * 2);
      bankCtx.strokeStyle = "#666";
      bankCtx.lineWidth = 2;
      bankCtx.stroke();
      const rad = angle * Math.PI / 180;
      const dx = Math.cos(rad) * r;
      const dy = Math.sin(rad) * r;
      bankCtx.beginPath();
      bankCtx.moveTo(cx - dx, cy - dy);
      bankCtx.lineTo(cx + dx, cy + dy);
      bankCtx.strokeStyle = "green";
      bankCtx.lineWidth = 3;
      bankCtx.stroke();
      bankCtx.font = "14px sans-serif";
      bankCtx.fillStyle = "#000";
      bankCtx.textAlign = "center";
      bankCtx.fillText(`${Math.round(angle)}°`, cx, cy + r - 10);
      bankCtx.fillText(`バンク角 8`, cx, cy - r + 25);
    }

    function drawPitchMeter(angle) {
      const cx = pitchCanvas.width / 2;
      const cy = pitchCanvas.height / 2;
      const r = pitchCanvas.height / 2;
      pitchCtx.clearRect(0, 0, pitchCanvas.width, pitchCanvas.height);
      pitchCtx.beginPath();
      pitchCtx.arc(cx, cy, r, 0, Math.PI * 2);
      pitchCtx.strokeStyle = "#999";
      pitchCtx.lineWidth = 2;
      pitchCtx.stroke();
      const rad = angle * Math.PI / 180;
      const dx = Math.sin(rad) * r;
      const dy = -Math.cos(rad) * r;
      pitchCtx.beginPath();
      pitchCtx.moveTo(cx, cy);
      pitchCtx.lineTo(cx + dx, cy + dy);
      pitchCtx.strokeStyle = "orange";
      pitchCtx.lineWidth = 3;
      pitchCtx.stroke();
      pitchCtx.font = "14px sans-serif";
      pitchCtx.fillStyle = "#000";
      pitchCtx.textAlign = "center";
      pitchCtx.fillText(`${Math.round(angle)}°`, cx, cy + r - 16);
      pitchCtx.fillText(`ピッチ`, cx, cy - r + 25);
    }

    function drawStickMeter(angle) {
      const cx = stickCanvas.width / 2;
      const cy = stickCanvas.height / 2;
      const r = stickCanvas.height / 2;
      stickCtx.clearRect(0, 0, stickCanvas.width, stickCanvas.height);
      stickCtx.beginPath();
      stickCtx.arc(cx, cy, r, 0, Math.PI * 2);
      stickCtx.strokeStyle = "#999";
      stickCtx.lineWidth = 2;
      stickCtx.stroke();
      const rad = (angle + 0) *5 * Math.PI / 180; //表示５倍
      const dx = Math.sin(rad) * r;
      const dy = -Math.cos(rad) * r;
      stickCtx.beginPath();
      stickCtx.moveTo(cx, cy);
      stickCtx.lineTo(cx + dx, cy + dy);
      stickCtx.strokeStyle = "orange";
      stickCtx.lineWidth = 3;
      stickCtx.stroke();
      stickCtx.font = "14px sans-serif";
      stickCtx.fillStyle = "#000";
      stickCtx.textAlign = "center";
      stickCtx.fillText(`${Math.round(angle)}°`, cx, cy + r - 16);
      stickCtx.fillText(`桿`, cx, cy - r + 25);
    }



    const mapImg = new Image();
    mapImg.src = "menuma-Map.png"; // ファイル名は適宜調整

    const planeImg = new Image();
    planeImg.src = "Glider6.png"; // 画像ファイル名を適宜変更

    function drawGlider() {
      mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
      // 地図画像を背景に描画
      if (mapImg.complete && mapImg.naturalWidth !== 0) {
        mapCtx.drawImage(mapImg, 0, 0, mapCanvas.width, mapCanvas.height);
      }

      if (planeImg.complete) {
        // 画像の中心が(xPos, yPos)になるように描画
        const imgW = 32, imgH = 32; // 画像サイズに合わせて調整
        mapCtx.save();
        mapCtx.translate(xPos, yPos);
        mapCtx.rotate((deg+90) * Math.PI / 180); // degで回転
        mapCtx.drawImage(planeImg, -imgW/2, -imgH/2, imgW, imgH);
        mapCtx.restore();
      } else {
        // 画像がまだ読み込まれていない場合は丸を描画
        mapCtx.beginPath();
        mapCtx.arc(xPos, yPos, 10, 0, 2 * Math.PI);
        mapCtx.fillStyle = "blue";
        mapCtx.fill();
      }
      //mapCtx.font = "12px sans-serif";
      //mapCtx.fillStyle = "#000";
      //mapCtx.fillText("機体", xPos, yPos - 15);
    }


    function update() {
      if( stickDeg < 2 && stickDeg > -2 ) stickDeg = 0;
      if( stickDeg >= 2 ) stickDeg -= 2;
      if( stickDeg <= -2 ) stickDeg += 2;
      if( pitchDeg < 2 && pitchDeg > -2 ) pitchDeg = 0;
      if( pitchDeg >= 2 ) pitchDeg -= 2;
      if( pitchDeg <= -2 ) pitchDeg += 2;   

      bankDeg += (stickDeg - 0) / 20;
      if(bankDeg > 90) bankDeg = 90;
      if(bankDeg < -90) bankDeg = -90;
      deg += bankDeg / 5;
      const rad = deg * Math.PI / 180;
      const speed = velocity / 100 / 2;
      xPos += Math.cos(rad) * speed;
      yPos += Math.sin(rad) * speed;
      if (xPos < 0) xPos = mapCanvas.width;
      if (xPos > mapCanvas.width) xPos = 0;
      if (yPos < 0) yPos = mapCanvas.height;
      if (yPos > mapCanvas.height) yPos = 0;


      const pitchEffect = pitchDeg / 10.0;
      velocity -= pitchEffect * 0.8;
      altitude += pitchEffect * 1.5;
      velocity -= spoilerRatio * 0.2;
      altitude -= spoilerRatio * 0.3;

      drawBankMeter(bankDeg);
      drawStickMeter(stickDeg);
      drawPitchMeter(pitchDeg);
      drawGlider();
      info.textContent = `バンク: ${Math.round(stickDeg)}°, ピッチ: ${Math.round(pitchDeg)}°, 高度: ${Math.round(altitude)}m, 速度: ${Math.round(velocity)}km/h`;
      if(altitude < 0) {
        info.textContent += " (着陸しました)";
        return; // 着陸したら更新停止
      } else if(altitude < 20) {
        info.textContent += " (高度注意)";
      } else if(altitude > 300) {
        info.textContent += " (高度オーバー)";
      } else if(velocity < 40) {
        info.textContent += " (失速)";
        retuern; // 失速したら更新停止
      } else if(velocity > 50) {
        info.textContent += " (失速注意)";
      } else if(Math.abs(bankDeg) > 45) {
        info.textContent += " (横転注意)";
      } else if(Math.abs(bankDeg) > 30) {
        info.textContent += " (バンク注意)";
      } else if(Math.abs(pitchDeg) > 20) {
        info.textContent += " (ピッチ注意)";
      } else if(Math.abs(pitchDeg) > 10) {
        info.textContent += " (ピッチ大)";
      } else if(Math.abs(pitchDeg) > 5) {
        info.textContent += " (ピッチ中)";
      } else if(Math.abs(pitchDeg) > 2) {
        info.textContent += " (ピッチ小)";
      } else {
        info.textContent += " (安定飛行)";
      } 

      setTimeout(update, updateInterval);
    }

    window.onload = update;
    const spoilerSlider = document.getElementById('spoilerSlider');
    const spoilerValue = document.getElementById('spoilerValue');
    spoilerSlider.addEventListener('input', function() {
      spoilerValue.textContent = spoilerSlider.value;
      spoilerRatio = spoilerSlider.value;// 必要ならここでspoilerSlider.valueを使って処理
    });
  </script>
</body>
</html>