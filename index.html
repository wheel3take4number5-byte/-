<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Glider Viewer</title>
  <style>
    body { margin: 0; background: #fff; font-family: sans-serif; }
    <button id="permissionBtn">センサー許可</button>
    canvas { border: 1px solid #ccc; }
    #info {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #fff;
      padding: 6px 12px;
      border: 1px solid #999;
      border-radius: 4px;
      font-size: 14px;
    }
    #permissionBtn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      padding: 8px 16px;
      font-size: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="info">状態: 初期化中</div>
  <button id="permissionBtn">センサー許可 </button>
  <canvas id="bankMeter" width="120" height="120" style="position:absolute; top:10px; left:10px;"></canvas>
  <canvas id="pitchMeter" width="120" height="120" style="position:absolute; top:140px; left:10px;"></canvas>
  <canvas id="mapArea" width="300" height="300" style="position:absolute; top:10px; left:150px;"></canvas>

  <script>
    const bankCanvas = document.getElementById("bankMeter");
    const bankCtx = bankCanvas.getContext("2d");
    const pitchCanvas = document.getElementById("pitchMeter");
    const pitchCtx = pitchCanvas.getContext("2d");
    const mapCanvas = document.getElementById("mapArea");
    const mapCtx = mapCanvas.getContext("2d");
    const info = document.getElementById("info");
    const permissionBtn = document.getElementById("permissionBtn");

    let bankDeg = 0;
    let pitchDeg = 0;
    let xPos = mapCanvas.width / 2;
    let yPos = mapCanvas.height / 2;
    let altitude = 100;
    let velocity = 100;
    let deg = -90;
    const updateInterval = 200;

    function handleOrientation(event) {
      bankDeg = event.gamma || 0;
      pitchDeg = (event.beta || 90) - 90;
    }

    permissionBtn.onclick = () => {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') {
              window.addEventListener("deviceorientation", handleOrientation);
              permissionBtn.style.display = "none";
              update(); // ← 許可後に開始
            } else {
              alert("センサーの許可が必要です");
            }
          })
          .catch(err => {
            console.error("センサー許可エラー:", err);
            alert("センサー許可に失敗しました");
          });
      } else {
        window.addEventListener("deviceorientation", handleOrientation);
        permissionBtn.style.display = "none";
        update(); // ← Androidなどは即開始
      }
    };

    function handleOrientation(event) {
      console.log("gamma:", event.gamma, "beta:", event.beta);
      bankDeg = event.gamma ?? 0;
      pitchDeg = (event.beta ?? 90) - 90;
    }

    function drawBankMeter(angle) {
      const cx = bankCanvas.width / 2;
      const cy = bankCanvas.height / 2;
      const r = 50;
      bankCtx.clearRect(0, 0, bankCanvas.width, bankCanvas.height);
      bankCtx.beginPath();
      bankCtx.arc(cx, cy, r, 0, Math.PI * 2);
      bankCtx.strokeStyle = "#666";
      bankCtx.lineWidth = 2;
      bankCtx.stroke();
      const rad = angle * Math.PI / 180;
      const dx = Math.cos(rad) * r;
      const dy = Math.sin(rad) * r;
      bankCtx.beginPath();
      bankCtx.moveTo(cx - dx, cy - dy);
      bankCtx.lineTo(cx + dx, cy + dy);
      bankCtx.strokeStyle = "green";
      bankCtx.lineWidth = 3;
      bankCtx.stroke();
      bankCtx.font = "14px sans-serif";
      bankCtx.fillStyle = "#000";
      bankCtx.textAlign = "center";
      bankCtx.fillText(`${Math.round(angle)}°`, cx, cy + r - 10);
      bankCtx.fillText(`バンク角 Add`, cx, cy - r + 25);
    }

    function drawPitchMeter(angle) {
      const cx = pitchCanvas.width / 2;
      const cy = pitchCanvas.height / 2;
      const r = 50;
      pitchCtx.clearRect(0, 0, pitchCanvas.width, pitchCanvas.height);
      pitchCtx.beginPath();
      pitchCtx.arc(cx, cy, r, 0, Math.PI * 2);
      pitchCtx.strokeStyle = "#999";
      pitchCtx.lineWidth = 2;
      pitchCtx.stroke();
      const rad = angle * Math.PI / 180;
      const dx = Math.sin(rad) * r;
      const dy = -Math.cos(rad) * r;
      pitchCtx.beginPath();
      pitchCtx.moveTo(cx, cy);
      pitchCtx.lineTo(cx + dx, cy + dy);
      pitchCtx.strokeStyle = "orange";
      pitchCtx.lineWidth = 3;
      pitchCtx.stroke();
      pitchCtx.font = "14px sans-serif";
      pitchCtx.fillStyle = "#000";
      pitchCtx.textAlign = "center";
      pitchCtx.fillText(`${Math.round(angle)}°`, cx, cy + r - 16);
      pitchCtx.fillText(`ピッチ`, cx, cy - r + 25);
    }

    function drawMap() {
      mapCtx.clearRect(0, 0, mapCanvas.width, mapCanvas.height);
      mapCtx.beginPath();
      mapCtx.arc(xPos, yPos, 10, 0, 2 * Math.PI);
      mapCtx.fillStyle = "blue";
      mapCtx.fill();
      mapCtx.font = "12px sans-serif";
      mapCtx.fillStyle = "#000";
      mapCtx.fillText("機体", xPos, yPos - 15);
    }

    function update() {
      deg += bankDeg / 5;
      const rad = deg * Math.PI / 180;
      const speed = velocity / 100 * 2;
      xPos += Math.cos(rad) * speed;
      yPos += Math.sin(rad) * speed;

      const pitchEffect = pitchDeg / 10.0;
      velocity -= pitchEffect * 0.8;
      altitude += pitchEffect * 1.5;

      drawBankMeter(bankDeg);
      drawPitchMeter(pitchDeg);
      drawMap();
      info.textContent = `バンク: ${Math.round(bankDeg)}°, ピッチ: ${Math.round(pitchDeg)}°, 高度: ${Math.round(altitude)}m, 速度: ${Math.round(velocity)}km/h`;

      setTimeout(update, updateInterval);
    }

    window.onload = update;
  </script>
</body>
</html>